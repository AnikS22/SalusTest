# SALUS A100 Configuration
# Optimized for NVIDIA A100 80GB

system:
  project_name: "SALUS"
  experiment_name: "salus_a100_scale"
  seed: 42
  num_gpus: 1  # Single A100 80GB

# A100 GPU allocation
gpu_allocation:
  device: "cuda:0"
  memory_fraction: 0.95  # Use 95% of 80GB = 76GB

# Data collection settings (scaled for A100)
data_collection:
  num_episodes: 500  # Target for initial A100 run
  max_episode_length: 200
  num_parallel_envs: 8  # 8 parallel Isaac Sim environments
  save_frequency: 20  # Save every 20 episodes
  checkpoint_frequency: 100  # Checkpoint every 100 episodes

  # Storage settings
  data_format: "zarr"
  compression: "zstd"
  chunk_size: 1000

  # Monitoring
  log_frequency: 10
  wandb_enabled: true
  wandb_project: "salus-a100-scale"

# IsaacLab environment settings
environment:
  name: "FrankaPickPlace"
  num_envs: 8  # Parallel environments
  episode_length: 200
  control_freq: 30  # Hz
  render: false  # Headless for speed

  # Robot settings
  robot:
    name: "franka_panda"
    dof: 7
    control_mode: "position"

  # Camera settings (smaller resolution for speed)
  cameras:
    - name: "camera1"  # Front view
      resolution: [224, 224]  # Reduced from 256
      position: [0.7, 0.0, 0.5]
      target: [0.0, 0.0, 0.3]
    - name: "camera2"  # Side view
      resolution: [224, 224]
      position: [0.0, 0.7, 0.5]
      target: [0.0, 0.0, 0.3]
    - name: "camera3"  # Top view
      resolution: [224, 224]
      position: [0.0, 0.0, 1.2]
      target: [0.0, 0.0, 0.3]

  # Task settings
  task:
    name: "pick_place"
    object: "red_cube"
    object_size: [0.05, 0.05, 0.05]
    goal_position: [0.3, 0.5, 0.2]
    success_threshold: 0.05

    # Failure injection for diversity
    perturbations:
      enabled: true
      frequency: 0.2  # 20% of episodes
      types:
        - "random_force"
        - "object_slip"
        - "sensor_noise"

# VLA settings
vla:
  model_path: "~/models/smolvla/smolvla_base"
  ensemble_size: 1  # Single model for speed
  device: "cuda:0"

  # Signal extraction
  signal_dim: 12
  history_length: 10

# Predictor settings (A100 optimized)
predictor:
  input_dim: 12
  hidden_dims: [128, 256, 256, 256, 128, 64]  # Larger model (~200K params)
  output_horizons: 4  # [200ms, 300ms, 400ms, 500ms]
  failure_types: 4  # [collision, drop, timeout, other]
  dropout: 0.3  # More dropout for larger model

  training:
    batch_size: 1024  # Large batch for A100
    learning_rate: 0.001
    epochs: 100
    early_stopping_patience: 15
    device: "cuda:0"
    use_amp: true  # FP16 mixed precision
    num_workers: 8  # Parallel data loading
    pin_memory: true
    persistent_workers: true

    # Optimizer settings
    optimizer: "adamw"
    weight_decay: 0.0001
    scheduler: "cosine"
    warmup_epochs: 5

    # Loss settings
    pos_weight: 3.0  # Handle class imbalance
    label_smoothing: 0.1

# Manifold settings (for future work)
manifold:
  obs_dim: 6
  action_dim: 7
  latent_dim: 16  # Larger latent space

  training:
    batch_size: 512
    learning_rate: 0.0001
    epochs: 200
    margin: 0.5
    device: "cuda:0"
    use_amp: true

# Logging and monitoring
logging:
  level: "INFO"
  log_dir: "a100_logs"
  tensorboard: true
  save_videos: false
  save_videos_frequency: 100

# Resource management (A100 optimized)
resources:
  max_workers: 8  # Parallel workers
  prefetch_factor: 4  # Data loading prefetch
  pin_memory: true
  persistent_workers: true

# Evaluation settings
evaluation:
  batch_size: 2048  # Large batch for fast evaluation
  horizons_ms: [200, 300, 400, 500]
  compute_per_horizon_metrics: true
  compute_per_type_metrics: true
  save_predictions: true  # Save predictions for analysis

# Temporal forecasting specific settings
temporal_forecasting:
  horizons:
    - name: "h1_200ms"
      steps: 6
      weight: 1.0
    - name: "h2_300ms"
      steps: 9
      weight: 1.0
    - name: "h3_400ms"
      steps: 12
      weight: 0.8
    - name: "h4_500ms"
      steps: 15
      weight: 0.6

  # Temporal consistency loss
  temporal_consistency:
    enabled: true
    weight: 0.1

  # Early warning system
  early_warning:
    enabled: true
    min_confidence: 0.7  # Only warn if >70% confidence
    min_horizon: 200  # Minimum 200ms lead time
